<div class="main_page">
  <app-alerts></app-alerts>
  <app-side-menu></app-side-menu>
  <div class="page_main_blocks middle_page">
    <div class="page_header">
      <app-header></app-header>
    </div>
    <div class="page_body_title" [ngClass]="{ pageNotLoaded: !pageLoaded }">
      <h3><i class="fas fa-sort-shapes-down-alt"></i>طلبات المبيعات</h3>
      <div class="button-add-taxs" style="margin-left: 19px;">
        <button
          routerLink="/sales/orders-sales-map"
          *ngIf="order_add || user.privilege == 'super-admin'"
        >
          <i class="fas fa-map"></i>خريطة المبيعات
        </button>
        <button
          routerLink="/sales/add-sale"
          style="margin-right: 20px;"
          *ngIf="order_add || user.privilege == 'super-admin'"
        >
          <i class="fal fa-file-plus"></i>اضافة مبيعات جديدة
        </button>
      </div>

      <!-- <a
          routerLink="/sales/add-sale"
          *ngIf="order_add || user.privilege == 'super-admin'"
        >
          إضافة طلب مبيعات جديد
          <i class="fas fa-plus"></i>
        </a> -->
    </div>
    <div class="page_body">
      <div class="page_body_main">
        <div class="page_block">
          <div class="main_block filterMainBlock">
            <form class="filter_form" [formGroup]="filterForm">
              <div id="todaysOrdersContainer">
                <div id="CheckBoxTodayFilter">
                  <label class="todayfilterLabel">طلبات اليوم</label>
                  <mat-slide-toggle
                    dir="rtl"
                    (change)="todayDateFillterToggle($event)"
                    [checked]="todayOrdersToggelChecked"
                    required
                  ></mat-slide-toggle>
                </div>
              </div>
              <div class="form_input" id="smallFillterInputStyle">
                <mat-form-field appearance="outline" dir="rtl">
                  <input
                    class="filterInput"
                    matInput
                    placeholder="اسم العميل /  رقم الموبايل"
                    autocomplete="off"
                    id="filterName"
                    formControlName="filterName"
                  />
                  <button
                    style=" background-color: white;"
                    type="button"
                    class="resetInput"
                    (click)="xResetInputs('filterName')"
                  >
                    <i class="fas fa-times-circle"></i>
                  </button>
                </mat-form-field>
              </div>
              <div
                class="form_input"
                id="smallFillterInputStyle"
                [ngClass]="{ backGround: todayFilltered }"
              >
                <mat-form-field appearance="outline" dir="rtl">
                  <input
                    class="filterInput"
                    (dateInput)="orderDateChanged($event, 'from')"
                    matInput
                    [matDatepicker]="fromFilterDate"
                    placeholder="تاريخ الاضافة"
                    autocomplete="off"
                    formControlName="startDateFilter"
                    id="filterStartDate"
                    readonly
                  />
                  <button
                    type="button"
                    class="resetInput"
                    (click)="xResetInputs('startDateFilter')"
                  >
                    <i class="fas fa-times-circle"></i>
                  </button>
                  <mat-datepicker-toggle
                    class="dateButton"
                    [for]="fromFilterDate"
                  >
                  </mat-datepicker-toggle>
                  <mat-datepicker touchUi #fromFilterDate> </mat-datepicker>
                </mat-form-field>
              </div>
              <div
                class="form_input"
                id="smallFillterInputStyle"
                [ngClass]="{ backGround: todayFilltered }"
              >
                <mat-form-field appearance="outline" dir="rtl">
                  <input
                    class="filterInput"
                    id="styleDisable"
                    (dateInput)="orderDateChanged($event, 'to')"
                    matInput
                    [matDatepicker]="toFilterDate"
                    placeholder="تاريخ الطلب"
                    autocomplete="off"
                    formControlName="endDateFilter"
                  />
                  <button
                    type="button"
                    class="resetInput"
                    (click)="xResetInputs('endDateFilter')"
                  >
                    <i class="fas fa-times-circle"></i>
                  </button>
                  <mat-datepicker-toggle
                    class="dateButton"
                    [for]="toFilterDate"
                  >
                  </mat-datepicker-toggle>
                  <mat-datepicker touchUi #toFilterDate> </mat-datepicker>
                </mat-form-field>
              </div>
              <div class="form_input" id="smallFillterInputStyle">
                <mat-form-field appearance="outline" dir="rtl">
                  <mat-select
                    placeholder="حالة الطلب"
                    (selectionChange)="orderStatusChange($event.value)"
                    multiple
                  >
                    <mat-option
                      *ngFor="let status of orderStatusArray"
                      [value]="status.id"
                      >{{ status.name }}</mat-option
                    >
                  </mat-select>
                </mat-form-field>
              </div>
              <div class="form_input" id="smallFillterInputStyle">
                <mat-form-field appearance="outline" dir="rtl">
                  <input
                    class="filterInput"
                    matInput
                    placeholder="اضافة لواسطة"
                    autocomplete="off"
                    id="filterNameby"
                    formControlName="filterNameby"
                  />
                  <button
                    style=" background-color: white;"
                    type="button"
                    class="resetInput"
                    (click)="xResetInputs('filterNameby')"
                  >
                    <i class="fas fa-times-circle"></i>
                  </button>
                </mat-form-field>
              </div>
              <div class="form_input" id="smallFillterInputStyle">
                <mat-form-field appearance="outline" dir="rtl">
                  <mat-select
                    placeholder="الخدمة"
                    (selectionChange)="servicesChange($event.value)"
                    multiple
                  >
                    <mat-option
                      *ngFor="let service of servicesArray"
                      [value]="service.id"
                      >{{ service.name }}</mat-option
                    >
                  </mat-select>
                </mat-form-field>
              </div>
              <div class="form_input" id="timePicker">
                <div class="timePickerContainer">
                  <input
                    formControlName="startObj"
                    placeholder="الوقت يبدأ من"
                    [ngxTimepicker]="startTime"
                    id="startObj"
                    readonly
                  />
                  <ngx-material-timepicker
                    (timeSet)="timeChanged($event, 'start')"
                    #startTime
                    enableKeyboardInput="true"
                    [ngxMaterialTimepickerTheme]="darkTheme"
                  ></ngx-material-timepicker>
                </div>
              </div>
              <div
                class="form_input"
                style="margin-right: 10px;"
                id="timePicker2"
              >
                <div class="timePickerContainer">
                  <input
                    formControlName="endObj"
                    placeholder="الوقت ينتهى فى"
                    [ngxTimepicker]="endTime"
                    readonly
                  />
                  <ngx-material-timepicker
                    (timeSet)="timeChanged($event, 'end')"
                    #endTime
                    enableKeyboardInput="true"
                    [ngxMaterialTimepickerTheme]="darkTheme"
                  ></ngx-material-timepicker>
                </div>
              </div>
              <div
                class="form_input cityInputSelect"
                id="smallFillterInputStyle"
              >
                <mat-form-field appearance="outline" dir="rtl">
                  <mat-select
                    placeholder="المدينة"
                    (selectionChange)="orderCity($event.value)"
                    multiple
                  >
                    <mat-option
                      *ngFor="let city of cityArray"
                      [value]="city.id"
                      >{{ city.name }}</mat-option
                    >
                  </mat-select>
                </mat-form-field>
              </div>
            </form>
          </div>

          <div class="countPerPage">
            <select
              name=""
              id=""
              (change)="setCountPerPage($event.target.value)"
              class="selectPerpage"
            >
              <option *ngFor="let option of countPerPage" [value]="option">
                {{ option }}
              </option>
            </select>
          </div>
          <table
            width="100%"
            dir="rtl"
            mat-table
            [dataSource]="ordersArray"
            class="mat-elevation-z8"
            style="margin-top: 40px;"
            id="display_table"
          >
            <ng-container matColumnDef="ID">
              <th mat-header-cell *matHeaderCellDef>#</th>
              <td mat-cell *matCellDef="let element">
                <span class="styleBold">{{ element.id }} </span>
              </td>
            </ng-container>
            <ng-container matColumnDef="technical_name">
              <th mat-header-cell *matHeaderCellDef>الحالة</th>
              <td mat-cell *matCellDef="let element">
                <div
                  style="padding: 10px 15px;
                background: #aaa517;color: #fff;
                "
                  *ngIf="element.status.name == 'محول'"
                >
                  <i class="fas fa-random" style="margin-left: 5px;"></i>
                  <span> {{ element.status ? element.status.name : '' }}</span>
                </div>
                <div
                  style="padding: 10px 15px;
                background: #FF0404;color: #fff;
                "
                  *ngIf="element.status.name == 'جديد'"
                >
                  <i class="fas fa-pennant" style="margin-left: 5px;"></i>
                  <span> {{ element.status ? element.status.name : '' }}</span>
                </div>
                <div
                  style="padding: 10px 15px;
                background: #17AA52;color: #fff;
                "
                  *ngIf="element.status.name == 'تم'"
                >
                  <i class="fas fa-check" style="margin-left: 5px;"></i>
                  <span> {{ element.status ? element.status.name : '' }}</span>
                </div>
                <div
                  style="padding: 10px 15px;
              background: #FF6913;color: #fff;
              "
                  *ngIf="element.status.name == 'انتظار'"
                >
                  <i class="fas fa-pause" style="margin-left: 5px;"></i>
                  <span> {{ element.status ? element.status.name : '' }}</span>
                </div>
              </td>
            </ng-container>
            <ng-container matColumnDef="client_name">
              <th mat-header-cell *matHeaderCellDef>إسم العميل</th>
              <td mat-cell *matCellDef="let element">
                {{ element.client ? element.client.user.name : '' }}
              </td>
            </ng-container>

            <ng-container matColumnDef="main_service">
              <th mat-header-cell *matHeaderCellDef>رقم الموبايل</th>
              <td mat-cell *matCellDef="let element">
                {{ element.client ? element.client.user.mobile : '' }}
              </td>
            </ng-container>
            <ng-container matColumnDef="service_date">
              <th mat-header-cell *matHeaderCellDef>إضافة بواسطة</th>
              <td mat-cell *matCellDef="let element">
                {{ element.creator ? element.creator.name : '' }}
              </td>
            </ng-container>
            <ng-container matColumnDef="order_res">
              <th mat-header-cell *matHeaderCellDef>المصدر</th>
              <td mat-cell *matCellDef="let element">
                {{ element.source ? element.source.name : '' }}
              </td>
            </ng-container>
            <ng-container matColumnDef="city">
              <th mat-header-cell *matHeaderCellDef>المدينة</th>
              <td mat-cell *matCellDef="let element">
                {{ element.location ? element.location.city.name : '' }}
              </td>
            </ng-container>
            <ng-container matColumnDef="order_time">
              <th mat-header-cell *matHeaderCellDef>الخدمة</th>
              <td mat-cell *matCellDef="let element">
                {{ element.service ? element.service.parent_service.name : '' }}
              </td>
            </ng-container>
            <ng-container matColumnDef="order_status">
              <th mat-header-cell *matHeaderCellDef>تاريخ الاضافة</th>
              <td mat-cell *matCellDef="let element">
                {{ element.created_at ? element.created_at : '' }}
              </td>
            </ng-container>
            <ng-container matColumnDef="order_resource">
              <th mat-header-cell *matHeaderCellDef>تاريخ الطلب و الوقت</th>
              <td mat-cell *matCellDef="let element">
                <p>{{ element.order_date ? element.order_date : '' }}</p>
                <p>{{ element.start }} - {{ element.end }}</p>
              </td>
            </ng-container>
            <ng-container matColumnDef="order_details">
              <th mat-header-cell *matHeaderCellDef>التفاصيل</th>
              <td
                mat-cell
                *matCellDef="let element"
                (mouseenter)="hideme[element.id] = !hideme[element.id]"
                (mouseleave)="hideme[element.id] = !hideme[element.id]"
              >
                <div
                  id="showOrdercontrols"
                  [ngClass]="{ showtestOrderControl: showOrdercontrolst }"
                  *ngIf="hideme[element.id]"
                >
                  <button
                    *ngIf="order_delete || user.privilege == 'super-admin'"
                    (click)="
                      openDeletePopup(element.id, element.client.user.name)
                    "
                    class="basic_button"
                    type="button"
                  >
                    <img src="../../../../assets/img/icons/delete.png" alt="" />
                    <span class="tooltiptext">حذف</span>
                  </button>
                  <button
                    id="editButton"
                    [routerLink]="['/sales/update-sale']"
                    [queryParams]="{
                      updateMode: true,
                      updatedOrderId: element.id
                    }"
                    class="basic_button"
                    type="button"
                    *ngIf="user.privilege == 'super-admin'"
                  >
                    <img src="../../../../assets/img/icons/edit.png" alt="" />
                    <span class="tooltiptext">تعديل</span>
                  </button>
                </div>

                <div class="basic_button" type="button">
                  <i class="fas fa-bars"></i>
                </div>
              </td>
            </ng-container>
            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>

          <div class="pagination">
            <ul>
              <li>
                <button
                  class="arrow"
                  [disabled]="current_page == totalPage"
                  (click)="nextPage(current_page)"
                >
                  <i class="fas fa-caret-right"></i>
                </button>
              </li>
              <li style="margin: 10px; text-align: center; line-height: 31px;">
                <div class="numberPagination">
                  <!-- {{ current_page }} -->
                  <input
                    style="background: #fff;
                 border: 1px solid rgba(112, 112, 112, 0.38);
                 width: 42px;
                 height: 31px;
                 text-align: center;"
                    type="text"
                    type="number"
                    min="1"
                    [max]="totalPage"
                    #pageNumber
                    [value]="current_page"
                    (keyup.enter)="changePagination(pageNumber)"
                  />
                </div>
              </li>
              <li>
                <button
                  class="arrow"
                  [disabled]="current_page <= 1"
                  (click)="prevPage(current_page)"
                >
                  <i class="fas fa-caret-left"></i>
                </button>
              </li>
              <li style="margin: 15px 10px; box-shadow: none;">
                <div class="pageNum">
                  من
                  <span>{{ totalPage }}</span>
                  صفحة
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="popup" *ngIf="showDeletePopup" [@parentAnimation]>
    <div id="backDrop" (click)="closePopup()"></div>
    <div id="popupData" [@childAnimation]>
      <div class="headerPopup">
        <p>
          <img
            class="fas fa-times"
            (click)="closePopup()"
            src="../../../../assets/img/icons/x.png"
            alt=""
          />
          حذف الطلب
        </p>
      </div>
      <div class="detailsPopup">
        <P>
          هل انت متأكد من حذف طلب العميل <br />
          {{ deletedOrderClientName }}
        </P>

        <div id="confirmationButtons">
          <button type="button" (click)="deleteTechnical()">نعم متأكد</button>
          <button type="button" (click)="closePopup()">إلغاء الحذف</button>
        </div>
      </div>
    </div>
  </div>
</div>
